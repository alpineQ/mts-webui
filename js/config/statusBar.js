$(function(){var G=window._service;var E=window._service.config;var d=null;var c=true;var o=false;var q={};var k=false;var j=false;var l=null;function w(){window.setTimeout(function(){var J=new e();window.setInterval(function(){var M=F();J.batteryPers=g(M.batteryPers,M.batteryStatus);var L=["prepare_install","low_battery","download_success","downloading"];if(M.isLoggedIn==true&&!($("#progress").is(":visible"))&&M.defaultWanName!=""){if($.inArray(M.current_upgrade_state,L)!=-1){if(null==d){if(!M.is_mandatory){$.modal.close()}a()}else{if(false==d){d=null}}}}},1000);var K=function(){var L=G.getStatusInfo();if(L.isLoggedIn){G.getUpgradeResult({},function(M){if(M.upgrade_result=="success"){y(true)}else{if(M.upgrade_result=="fail"){y(false)}else{window.setTimeout(K,1000)}}},function(){window.setTimeout(K,1000)})}else{window.setTimeout(K,1000)}};if(J.updateType=="mifi_fota"){K();window.setInterval(function(){var L=F();if(L.isLoggedIn&&L.defaultWanName!=""){if(L.new_version_state&&L.fota_package_already_download!="yes"&&!E.ALREADY_NOTICE){G.getUpgradeResult({},function(M){if(M.upgrade_result=="success"){y(true)}else{if(M.upgrade_result=="fail"){y(false)}else{if(o==false){E.ALREADY_NOTICE=true;showOTAAlert()}}}})}}},1000)}},1200);function I(){var J=F();if(J.isLoggedIn){G.getSMSReady({},function(K){if(K.sms_cmd_status_result=="1"){window.setTimeout(function(){I()},1000)}else{k=true}})}else{window.setTimeout(function(){I()},1000)}}getNetworkType=function(K){var J=K.toLowerCase();if(J==""||J=="limited service"){J="limited_service"}if(J=="no service"){J="no_service"}if(J=="limited_service"||J=="no_service"){$("#networkType","#statusBar").attr("data-trans","network_type_"+J);return $.i18n.prop("network_type_"+J)}else{$("#networkType","#statusBar").removeAttr("data-trans");return K}};if(E.HAS_SMS&&window.checkIsMenuExist("view/message/sms")){window.setInterval(function(){var K=F();if(window.location.hash=="#login"||D(K.simStatus)){return}for(key in q){var L=q[key];if($.now()-L>5000){delete (q["m"+L]);var J=$(".bubbleItem#m"+L,"#buttom-bubble");J.fadeOut(1000,function(){$(this).remove()})}}if(K.isLoggedIn){if(K.newSmsReceived&&!j){j=true;G.resetNewSmsReceivedVar();H()}if(K.smsReportReceived){G.resetSmsReportReceivedVar();t()}}},1000);if(E.SMS_DATABASE_SORT_SUPPORT){window.setInterval(function(){if(window.checkIsMenuExist("view/message/sms")){var J=F();if(J.isLoggedIn&&k&&!j&&!D(J.simStatus)){j=true;H()}}},20001)}}function H(){var K=5;var J=1;if(!E.dbMsgs||E.dbMsgs.length==0){K=500;J=10}G.getSMSMessages({page:0,smsCount:K,nMessageStoreType:0,tags:J,orderBy:"order by id desc"},function(L){if(L&&L.messages){z(L.messages,0)}j=false});G.getSMSMessages({page:0,smsCount:K,nMessageStoreType:1,tags:J,orderBy:"order by id desc"},function(L){if(L&&L.messages){z(L.messages,1)}j=false})}}var v=[];function z(I,H){if(!E.dbMsgs){E.dbMsgs=[]}if(v.length==0){$.each(E.dbMsgs,function(J,K){v.push(K.id)})}$.each(I,function(J,L){if($.inArray(L.id,v)==-1){v.push(L.id);E.dbMsgs.push(L);if(L.tag=="1"){u(L,false,H)}}else{for(var K=0;K<E.dbMsgs.length;K++){if(E.dbMsgs[K].id==L.id&&E.dbMsgs[K].content!=L.content&&L.tag=="1"){E.dbMsgs[K].content=L.content;u(L,true,H);break}}}})}function u(K,X,S){E.smsMaxId=K.id;var I=$.now();q["m"+I]=I;var H=K.number;if(A&&E.phonebook&&E.phonebook.length==0){A=false;if(E.HAS_PHONEBOOK){i()}else{E.phonebook=[]}}for(N in E.phonebook){if(getLastNumber(E.phonebook[N].pbm_number,E.SMS_MATCH_LENGTH)==getLastNumber(K.number,E.SMS_MATCH_LENGTH)){H=E.phonebook[N].pbm_name;break}}var J={mark:"m"+I,name:H,title:$.i18n.prop("sms"),titleTrans:"sms",tag:K.tag,content:K.content,datetime:K.time};if(f==null){f=$.template("newMessagePopTmpl",$("#newMessagePopTmpl"))}$(".bubbleItem:not(.report)","#buttom-bubble").remove();$.tmpl("newMessagePopTmpl",J).appendTo("#buttom-bubble");if((window.location.hash=="#sms"||window.location.hash=="#smslist")&&S=="1"){var O=E.currentChatObject&&E.currentChatObject==getLastNumber(K.number,E.SMS_MATCH_LENGTH);var T=getLastNumber(K.number,E.SMS_MATCH_LENGTH);var W=$("#smslist-item-"+T);if(W&&W.length>0){for(var N=0;E.listMsgs&&N<E.listMsgs.length;N++){if(getLastNumber(E.listMsgs[N].number,E.SMS_MATCH_LENGTH)==getLastNumber(K.number,E.SMS_MATCH_LENGTH)){E.listMsgs[N].id=K.id;E.listMsgs[N].latestId=K.id;E.listMsgs[N].latestSms=K.content;E.listMsgs[N].latestTime=K.time;if(!X){E.listMsgs[N].newCount++;E.listMsgs[N].totalCount++}break}}W.find(".smslist-item-checkbox p.checkbox").attr("id",K.id);W.find(".smslist-item-checkbox input:checkbox").val(K.id).attr("id","checkbox"+K.id);if(!X){var Q=W.find(".smslist-item-total-count").text();Q=Number(Q.substring(1,Q.length-1));W.find(".smslist-item-total-count").text("("+(Q+1)+")");if(!E.currentChatObject||E.currentChatObject!=getLastNumber(K.number,E.SMS_MATCH_LENGTH)){var M=W.find(".smslist-item-new-count").removeClass("hide");if(M&&M.text().length>0){M.text(Number(M.text())+1)}else{M.text(1)}}}if(W.find(".smslist-item-draft-flag").length>0){if(E.currentChatObject&&E.currentChatObject==getLastNumber(K.number,E.SMS_MATCH_LENGTH)){W.find(" td:nth-child(2)").removeClass("font-weight-bold")}else{W.find(" td:nth-child(2)").addClass("font-weight-bold")}}else{var L=W.find(".smslist-item-msg").text(K.content);L.closest("td").prop("title",K.content);W.find("span.clock-time").text(K.time);if(E.currentChatObject&&E.currentChatObject==getLastNumber(K.number,E.SMS_MATCH_LENGTH)){L.closest("tr").removeClass("font-weight-bold")}else{L.closest("tr").addClass("font-weight-bold")}}W.find(".smslist-item-repeat span").die().click(function(){forwardClickHandler(K.id)});var V=W;W.hide().remove();$("#smslist-table").prepend(V.show())}else{var P="";if(E.phonebook&&E.phonebook.length>0){for(N in E.phonebook){if(getLastNumber(E.phonebook[N].pbm_number,E.SMS_MATCH_LENGTH)==getLastNumber(K.number,E.SMS_MATCH_LENGTH)){P=E.phonebook[N].pbm_name;break}}}var R={id:K.id,name:P,number:K.number,latestId:K.id,totalCount:1,newCount:O?0:1,latestSms:K.content,latestTime:K.time,checked:false,hasDraft:false,itemId:getLastNumber(K.number,E.SMS_MATCH_LENGTH)};if(l==null){l=$.template("smsTableTmpl",$("#smsTableTmpl"))}$.tmpl("smsTableTmpl",{data:[R]}).prependTo("#smslist-table")}if(E.HAS_PHONEBOOK){$(".sms-add-contact-icon").removeClass("hide")}else{$(".sms-add-contact-icon").addClass("hide")}if(O){var U=$("#talk-item-"+K.id,"#chatlist");if(U&&U.length>0){$(".J_content pre",U).html(dealContent(K.content));$(".time .smslist-item-time",U).text(K.time);$(".smslist-item-repeat",U).die().click(function(){forwardClickHandler(K.id)});$(".smslist-item-delete",U).die().click(function(){deleteSingleItemClickHandler(K.id)})}else{$("#smsOtherTmpl").tmpl(K).appendTo("#chatlist");$(".clear-container","#chatpanel").animate({scrollTop:$("#chatlist").height()})}if(!E.SMS_SET_READ_WHEN_COMPLETE){G.setSmsRead({ids:[K.id]},$.noop)}else{if(E.SMS_SET_READ_WHEN_COMPLETE&&K.receivedAll){G.setSmsRead({ids:[K.id]},$.noop)}}}enableCheckbox($("#smslist-checkAll"))}if(window.location.hash=="#sim_messages"&&S=="0"){var P="";if(E.phonebook&&E.phonebook.length>0){for(N in E.phonebook){if(getLastNumber(E.phonebook[N].pbm_number,E.SMS_MATCH_LENGTH)==getLastNumber(K.number,E.SMS_MATCH_LENGTH)){P=E.phonebook[N].pbm_name;break}}}var R={id:K.id,name:P,number:K.number,content:K.content,time:K.time,tag:K.tag,checked:false,itemId:getLastNumber(K.number,E.SMS_MATCH_LENGTH)};if(X){var W=$(".simMsgList-item-class-"+R.id);W.hide().remove()}if(simMsgListTmpl==null){simMsgListTmpl=$.template("simMsgListTmpl",$("#simMsgListTmpl"))}$.tmpl("simMsgListTmpl",{data:[R]}).prependTo("#simMsgList_container")}}var F=function(){return G.getStatusInfo()};function D(H){return H=="modem_sim_undetected"||H=="modem_undetected"||H=="modem_sim_destroy"||H=="modem_waitpin"||H=="modem_waitpuk"||H=="modem_imsi_waitnck"}var A=true;var f=null;function t(){if(A&&E.phonebook&&E.phonebook.length==0){A=false;if(E.HAS_PHONEBOOK){i()}else{E.phonebook=[]}}G.getSMSDeliveryReport({page:0,smsCount:10},function(I){var H=I.messages;var J=[];$.each(H,function(K,L){if($.inArray(L.number,J)==-1){J.push(L.number);window.setTimeout(function(){var N=$.now();q["m"+N]=N;L.name=L.number;for(K in E.phonebook){if(getLastNumber(E.phonebook[K].pbm_number,E.SMS_MATCH_LENGTH)==getLastNumber(L.number,E.SMS_MATCH_LENGTH)){L.name=E.phonebook[K].pbm_name;break}}var O=$.i18n.prop("sms_delivery_report_"+L.content);var M={mark:"m"+N,name:L.name,title:$.i18n.prop("sms_report"),titleTrans:"sms_report",content:O,datetime:L.time,report:"report"};if(f==null){f=$.template("newMessagePopTmpl",$("#newMessagePopTmpl"))}$(".report","#buttom-bubble").remove();$.tmpl("newMessagePopTmpl",M).appendTo("#buttom-bubble")},100)}})},function(){})}function i(){var H=G.getPhoneBooks({page:0,data_per_page:2000,orderBy:"id",isAsc:false});n(H)}function n(H){if($.isArray(H.pbm_data)&&H.pbm_data.length>0){E.phonebook=H.pbm_data}}function e(){var H=this;var I=F();H.isShowFotaNewversionIcon=I.new_version_state&&I.fota_package_already_download!="yes"&&!E.isShowFotaIcon;H.isShowConnectionIcon=false;H.isShowRj45ConnectionIcon=false;H.hasWifi=E.HAS_WIFI;H.hasBattery=E.HAS_BATTERY;H.updateType=G.getUpdateType().update_type;H.networkType=ko.observable(getNetworkType(I.networkType));H.roamingStatus=I.roamingStatus?"R":"";H.pinStatus=I.pinStatus;H.pinStatusText="";H.batteryStatus=I.batteryStatus;H.batteryPers=g(I.batteryPers,I.batteryStatus);H.connectStatus=I.connectStatus;H.connectStatusText="";H.connectStatusTrans="";H.showAttachedDevices=I.wifiStatus;H.isLoggedIn=I.isLoggedIn;H.showSmsDeleteConfirm=false;H.smsUnreadCount=0;H.connectionCssClass="";H.rj45ConnectionCssClass=""}function g(J,H){var I=null;if("0"==H){if("1"==J){I="img/battery_one.png"}else{if("2"==J){I="img/battery_two.png"}else{if("3"==J){I="img/battery_three.png"}else{if("4"==J){I="img/battery_full.png"}else{I="img/battery_out.png"}}}}}else{I="img/battery_charging.gif"}if($("#batterCharging")&&$("#batterCharging").attr("src")!=I){$("#batterCharging").attr("src",I)}return I}function y(I){if((!($("#loading").is(":visible")))&&(!($("#confirm").is(":visible")))){var H=I?"ota_update_success":"ota_update_failed";o=true;showAlert(H,function(){o=false;window.location.hash="#settings_system_reset";if(E.UPGRADE_TYPE=="OTA"){G.clearUpdateResult({},$.noop())}})}else{window.setTimeout(function(){y(I)},1000)}}var b=0;function s(){var H=G.getCurrentUpgradeState();if(H.current_upgrade_state=="low_battery"){showInfo("ota_low_battery");clearInterval(b)}}var m=0;function a(){d=true;var H=G.getNewVersionState();function K(){var L=["downloading"];var M=G.getCurrentUpgradeState();if(M.current_upgrade_state.toLowerCase()=="idle"){addTimeout(K,1000)}else{if(($.inArray(M.current_upgrade_state,L)!=-1)&&(H.fota_new_version_state!="already_has_pkg")){hideLoading();B()}}}if(!($("#progress").is(":visible"))){K()}var J=0;var I=function(){var M=null;if(J<=3){J=J+1;M=G.getCurrentUpgradeState()}else{M=F()}var L=M.current_upgrade_state;if(d&&c==true){if(H.fota_new_version_state=="already_has_pkg"){if(L=="low_battery"){hideProgressBar();d=false;G.removeTimerThings("fota_current_upgrade_state",function(){});showInfo("ota_pkg_low_battery");window.clearTimeout(m);return}else{if(L=="prepare_install"){hideProgressBar();d=false;G.removeTimerThings("fota_current_upgrade_state",function(){});showInfo("ota_pkg_download_success");window.clearTimeout(m);b=setInterval(function(){s()},1000);return}}}else{if(L=="downloading"){r()}else{if(L=="download_failed"){hideProgressBar();d=false;showAlert("ota_download_failed");window.clearTimeout(m);return}else{if(L=="low_battery"){hideProgressBar();d=false;G.removeTimerThings("fota_current_upgrade_state",function(){});showInfo("ota_low_battery");window.clearTimeout(m);return}else{if(L=="prepare_install"){hideProgressBar();d=false;G.removeTimerThings("fota_current_upgrade_state",function(){});showInfo("ota_download_success");window.clearTimeout(m);b=setInterval(function(){s()},1000);return}else{d=false;hideProgressBar();window.clearTimeout(m);return}}}}}m=window.setTimeout(I,1000)}};if(d&&c==true){m=window.setTimeout(I,100)}else{window.clearTimeout(m)}}function h(H){var J=F();if(H){var I=G.getOpMode();if(!checkConnectedStatus(J.connectStatus,I.rj45_state,J.connectWifiStatus)){showAlert("ota_network_disconnected");return}if(J.fota_user_selector=="none"){C()}else{if(J.fota_user_selector=="accept"){a()}else{if(J.fota_user_selector=="cancel"){showAlert("ota_have_cancel")}else{if(J.fota_user_selector=="downloading_cancel"){showAlert("ota_have_cancel")}}}}}else{if(J.fota_user_selector=="none"){x()}else{if(J.fota_user_selector=="accept"){a()}else{if(J.fota_user_selector=="cancel"){}else{if(J.fota_user_selector=="downloading_cancel"){}}}}}}function r(){G.getPackSizeInfo({},function(I){var H;if(parseInt(I.fota_pkg_total_size)==0){H=0}else{H=parseInt(parseInt(I.fota_dl_pkg_size)*100/parseInt(I.fota_pkg_total_size))}if(H>100){H=100}if(H>=0){if(H>95){showProgressBar("ota_update","<br/>"+$.i18n.prop("ota_update_warning"))}setProgressBar(H)}})}function C(){G.setUpgradeSelectOp({selectOp:"1"},function(H){if(H.result=="success"){a()}})}function x(){G.setUpgradeSelectOp({selectOp:"0"},function(H){})}function B(){var J=G.getMandatory();var I=J.is_mandatory;var K=G.getPackSizeInfo();var H;if(parseInt(K.fota_pkg_total_size)==0){H=0}else{H=parseInt(parseInt(K.fota_dl_pkg_size)*100/parseInt(K.fota_pkg_total_size))}if(H>100){H=100}if(I){showProgressBar("ota_update","<br/>"+$.i18n.prop("ota_update_warning"))}else{var L="";if(E.UPGRADE_TYPE=="OTA"){L="<br/><br/><button id='btnStopUpgrade' onclick='stopOTAUpgrade();' class='btn-1 btn-primary'>"+$.i18n.prop("cancel")+"</button>"}showProgressBar("ota_update","<br/>"+$.i18n.prop("ota_update_warning")+L)}if(H>=0){setProgressBar(H)}}function p(J){var I=J.current_upgrade_state;if(I=="upgrade_pack_redownload"){showConfirm("","ota_interrupted",function(){h(1)},function(){h(0)})}else{var H=["prepare_install","low_battery","connecting_server","connect_server_success","downloading","accept"];if($.inArray(I,H)!=-1){a()}else{showConfirm("","ota_new_version",function(){h(1);E.ISNOW_NOTICE=false},function(){h(0);E.ISNOW_NOTICE=false})}}}showOTAAlert=function(){E.ISNOW_NOTICE=true;var H=G.getMandatory().is_mandatory;if(H){a()}else{var I={};I=G.getCurrentUpgradeState();p(I)}};stopOTAUpgrade=function(){G.setUpgradeSelectOp({selectOp:"2"},function(H){});d=false;window.clearTimeout(m);hideLoading();showAlert("ota_cancel")};window._status={init:w,showOTAAlert:showOTAAlert}});